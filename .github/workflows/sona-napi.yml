name: SONA NAPI Build & Publish

on:
  push:
    tags:
      - 'sona-v*'
    paths:
      - 'crates/sona/**'
      - 'npm/packages/sona/**'
      - '.github/workflows/sona-napi.yml'
  pull_request:
    paths:
      - 'crates/sona/**'
      - 'npm/packages/sona/**'
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to npm'
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64 GNU
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            node-file: sona.linux-x64-gnu.node
          # Linux x64 MUSL
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            node-file: sona.linux-x64-musl.node
          # Linux ARM64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            node-file: sona.linux-arm64-gnu.node
          # macOS x64
          - os: macos-13
            target: x86_64-apple-darwin
            node-file: sona.darwin-x64.node
          # macOS ARM64
          - os: macos-14
            target: aarch64-apple-darwin
            node-file: sona.darwin-arm64.node
          # Windows x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            node-file: sona.win32-x64-msvc.node
          # Windows ARM64
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            node-file: sona.win32-arm64-msvc.node

    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.target }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Install musl tools (Linux MUSL)
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Install dependencies
        working-directory: npm/packages/sona
        run: npm install

      - name: Build native module
        working-directory: npm/packages/sona
        env:
          CARGO_BUILD_TARGET: ${{ matrix.target }}
        run: |
          npm run build -- --target ${{ matrix.target }}

      - name: List built files
        working-directory: npm/packages/sona
        run: ls -la *.node || echo "No .node files"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.target }}
          path: npm/packages/sona/${{ matrix.node-file }}
          if-no-files-found: error

  # Build universal macOS binary
  universal-macos:
    runs-on: macos-14
    name: Universal macOS
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Download x64 artifact
        uses: actions/download-artifact@v4
        with:
          name: bindings-x86_64-apple-darwin
          path: artifacts/x64

      - name: Download ARM64 artifact
        uses: actions/download-artifact@v4
        with:
          name: bindings-aarch64-apple-darwin
          path: artifacts/arm64

      - name: Create universal binary
        run: |
          mkdir -p artifacts/universal
          lipo -create \
            artifacts/x64/sona.darwin-x64.node \
            artifacts/arm64/sona.darwin-arm64.node \
            -output artifacts/universal/sona.darwin-universal.node

      - name: Upload universal artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindings-darwin-universal
          path: artifacts/universal/sona.darwin-universal.node

  # Publish to npm
  publish:
    runs-on: ubuntu-latest
    name: Publish npm packages
    needs: [build, universal-macos]
    if: startsWith(github.ref, 'refs/tags/sona-v') || github.event.inputs.publish == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "=== All downloaded artifacts ==="
          find artifacts -name "*.node" -ls

      - name: Copy .node files to npm package
        working-directory: npm/packages/sona
        run: |
          # Copy all .node files from artifacts to the package directory
          cp ../../../artifacts/bindings-x86_64-unknown-linux-gnu/*.node . || true
          cp ../../../artifacts/bindings-x86_64-unknown-linux-musl/*.node . || true
          cp ../../../artifacts/bindings-aarch64-unknown-linux-gnu/*.node . || true
          cp ../../../artifacts/bindings-x86_64-apple-darwin/*.node . || true
          cp ../../../artifacts/bindings-aarch64-apple-darwin/*.node . || true
          cp ../../../artifacts/bindings-x86_64-pc-windows-msvc/*.node . || true
          cp ../../../artifacts/bindings-aarch64-pc-windows-msvc/*.node . || true
          cp ../../../artifacts/bindings-darwin-universal/*.node . || true

          echo "=== .node files in package ==="
          ls -la *.node

      - name: Install napi-rs CLI
        run: npm install -g @napi-rs/cli

      - name: Install dependencies
        working-directory: npm/packages/sona
        run: npm install

      - name: Prepare npm packages
        working-directory: npm/packages/sona
        run: |
          # Generate platform-specific packages using napi prepublish
          napi prepublish -t npm --skip-gh-release

          echo "=== Generated npm packages ==="
          ls -la npm/ || echo "No npm directory"

      - name: Create platform package.json files
        working-directory: npm/packages/sona
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "Version: $VERSION"

          # Create npm directory if it doesn't exist
          mkdir -p npm

          # Linux x64 GNU
          if [ -f "sona.linux-x64-gnu.node" ]; then
            mkdir -p npm/linux-x64-gnu
            cp sona.linux-x64-gnu.node npm/linux-x64-gnu/
            cat > npm/linux-x64-gnu/package.json << EOF
          {
            "name": "@ruvector/sona-linux-x64-gnu",
            "version": "$VERSION",
            "os": ["linux"],
            "cpu": ["x64"],
            "main": "sona.linux-x64-gnu.node",
            "files": ["sona.linux-x64-gnu.node"],
            "license": "MIT OR Apache-2.0",
            "repository": {
              "type": "git",
              "url": "https://github.com/ruvnet/ruvector.git"
            }
          }
          EOF
          fi

          # Linux x64 MUSL
          if [ -f "sona.linux-x64-musl.node" ]; then
            mkdir -p npm/linux-x64-musl
            cp sona.linux-x64-musl.node npm/linux-x64-musl/
            cat > npm/linux-x64-musl/package.json << EOF
          {
            "name": "@ruvector/sona-linux-x64-musl",
            "version": "$VERSION",
            "os": ["linux"],
            "cpu": ["x64"],
            "main": "sona.linux-x64-musl.node",
            "files": ["sona.linux-x64-musl.node"],
            "libc": ["musl"],
            "license": "MIT OR Apache-2.0"
          }
          EOF
          fi

          # Linux ARM64
          if [ -f "sona.linux-arm64-gnu.node" ]; then
            mkdir -p npm/linux-arm64-gnu
            cp sona.linux-arm64-gnu.node npm/linux-arm64-gnu/
            cat > npm/linux-arm64-gnu/package.json << EOF
          {
            "name": "@ruvector/sona-linux-arm64-gnu",
            "version": "$VERSION",
            "os": ["linux"],
            "cpu": ["arm64"],
            "main": "sona.linux-arm64-gnu.node",
            "files": ["sona.linux-arm64-gnu.node"],
            "license": "MIT OR Apache-2.0"
          }
          EOF
          fi

          # macOS x64
          if [ -f "sona.darwin-x64.node" ]; then
            mkdir -p npm/darwin-x64
            cp sona.darwin-x64.node npm/darwin-x64/
            cat > npm/darwin-x64/package.json << EOF
          {
            "name": "@ruvector/sona-darwin-x64",
            "version": "$VERSION",
            "os": ["darwin"],
            "cpu": ["x64"],
            "main": "sona.darwin-x64.node",
            "files": ["sona.darwin-x64.node"],
            "license": "MIT OR Apache-2.0"
          }
          EOF
          fi

          # macOS ARM64
          if [ -f "sona.darwin-arm64.node" ]; then
            mkdir -p npm/darwin-arm64
            cp sona.darwin-arm64.node npm/darwin-arm64/
            cat > npm/darwin-arm64/package.json << EOF
          {
            "name": "@ruvector/sona-darwin-arm64",
            "version": "$VERSION",
            "os": ["darwin"],
            "cpu": ["arm64"],
            "main": "sona.darwin-arm64.node",
            "files": ["sona.darwin-arm64.node"],
            "license": "MIT OR Apache-2.0"
          }
          EOF
          fi

          # Windows x64
          if [ -f "sona.win32-x64-msvc.node" ]; then
            mkdir -p npm/win32-x64-msvc
            cp sona.win32-x64-msvc.node npm/win32-x64-msvc/
            cat > npm/win32-x64-msvc/package.json << EOF
          {
            "name": "@ruvector/sona-win32-x64-msvc",
            "version": "$VERSION",
            "os": ["win32"],
            "cpu": ["x64"],
            "main": "sona.win32-x64-msvc.node",
            "files": ["sona.win32-x64-msvc.node"],
            "license": "MIT OR Apache-2.0"
          }
          EOF
          fi

          # Windows ARM64
          if [ -f "sona.win32-arm64-msvc.node" ]; then
            mkdir -p npm/win32-arm64-msvc
            cp sona.win32-arm64-msvc.node npm/win32-arm64-msvc/
            cat > npm/win32-arm64-msvc/package.json << EOF
          {
            "name": "@ruvector/sona-win32-arm64-msvc",
            "version": "$VERSION",
            "os": ["win32"],
            "cpu": ["arm64"],
            "main": "sona.win32-arm64-msvc.node",
            "files": ["sona.win32-arm64-msvc.node"],
            "license": "MIT OR Apache-2.0"
          }
          EOF
          fi

          echo "=== Platform packages created ==="
          ls -la npm/

      - name: Publish platform packages
        working-directory: npm/packages/sona
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for dir in npm/*/; do
            if [ -d "$dir" ]; then
              echo "Publishing $dir..."
              cd "$dir"
              npm publish --access public || echo "Warning: Failed to publish $dir (may already exist)"
              cd ../..
            fi
          done

      - name: Publish main package
        working-directory: npm/packages/sona
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "=== Main package contents ==="
          ls -la

          # Publish main package
          npm publish --access public

  # Test installation on all platforms
  test-install:
    runs-on: ${{ matrix.os }}
    name: Test ${{ matrix.os }}
    needs: publish
    if: startsWith(github.ref, 'refs/tags/sona-v')
    strategy:
      matrix:
        os: [ubuntu-latest, macos-14, windows-latest]

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Wait for npm propagation
        run: sleep 30

      - name: Test npm install
        run: |
          npm init -y
          npm install @ruvector/sona@latest
          node -e "const sona = require('@ruvector/sona'); console.log('SONA loaded successfully!'); console.log('SonaEngine:', typeof sona.SonaEngine);"
